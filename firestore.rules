/**
 * @fileoverview Firestore Security Rules for the Casino Membership Application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for membership data,
 * ensuring that users can only access and modify their own information.
 * Public read-only access is granted for tiers and rewards.
 *
 * Data Structure:
 * - /memberships/{membershipId}: Stores individual member profiles.
 * - /tiers/{tierId}: Stores membership tier definitions.
 * - /rewards/{rewardId}: Stores reward definitions.
 * - /memberships/{membershipId}/redemptions/{redemptionId}: Stores redemption records for a member.
 * - /memberships/{membershipId}/visitSummaries/{visitSummaryId}: Stores visit summaries for a member.
 * - /memberships/{membershipId}/transactions/{transactionId}: Stores transaction records for a member.
 *
 * Key Security Decisions:
 * - Memberships are private and accessible only to the authenticated user matching the membership ID.
 * - Tiers and Rewards are public read-only.
 * - Subcollections (redemptions, visitSummaries, transactions) are also user-owned.
 * - Data validation is limited to relational integrity checks, not full schema validation.
 *
 * Denormalization for Authorization:
 *  Path-based ownership is utilized, meaning the `membershipId` in the path
 *  is used to verify ownership, avoiding the need for document reads.
 *
 * Structural Segregation:
 * Public read-only data (Tiers, Rewards) is stored in top-level collections,
 * while private user data (Memberships, Redemptions, VisitSummaries, Transactions)
 * is stored either in a top-level collection secured by ownership or under
 * a user-owned document.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the existing document.
     *  This combines the `isOwner` check with `resource != null` to ensure the document exists.
     * @param userId The expected owner's user ID.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for the /memberships/{membershipId} collection.
     * @path /memberships/{membershipId}
     * @allow (create) User A can create their own membership document if authenticated (request.auth.uid == 'A').
     * @deny (create) User B cannot create a membership document with User A's ID (request.auth.uid == 'B', membershipId == 'A').
     * @allow (get) User A can read their own membership document (request.auth.uid == 'A').
     * @deny (get) User B cannot read User A's membership document (request.auth.uid == 'B', membershipId == 'A').
     * @principle Enforces document ownership for writes and reads.
     */
    match /memberships/{membershipId} {
      // Read rules: Any signed-in user can read the list of members.
      allow get, list: if isSignedIn();
      
      // Write rules: Any signed-in user can create/update/delete.
      allow write: if isSignedIn();
    }

    /**
     * @description Rules for the /tiers/{tierId} collection.
     * @path /tiers/{tierId}
     * @allow (get) Any user can read tier information.
     * @allow (list) Any user can list tier information.
     * @deny (create) No one can create tiers through the client.
     * @principle Provides public read-only access to tier data.
     */
    match /tiers/{tierId} {
      // Read rules: Public read access.
      allow get, list: if true;

      // Write rules: No client-side writes allowed.
      allow create, update, delete: if false;
    }

    /**
     * @description Rules for the /rewards/{rewardId} collection.
     * @path /rewards/{rewardId}
     * @allow (get) Any user can read reward information.
     * @allow (list) Any user can list reward information.
     * @deny (create) No one can create rewards through the client.
     * @principle Provides public read-only access to reward data.
     */
    match /rewards/{rewardId} {
      // Read rules: Public read access.
      allow get, list: if true;

      // Write rules: No client-side writes allowed.
      allow create, update, delete: if false;
    }

    /**
     * @description Rules for the /memberships/{membershipId}/redemptions/{redemptionId} collection.
     * @path /memberships/{membershipId}/redemptions/{redemptionId}
     * @allow (create) User A can create a redemption record under their membership (request.auth.uid == 'A').
     * @deny (create) User B cannot create a redemption record under User A's membership (request.auth.uid == 'B', membershipId == 'A').
     * @allow (get) User A can read their own redemption record.
     * @deny (get) User B cannot read User A's redemption record.
     * @principle Enforces document ownership for redemptions.
     */
    match /memberships/{membershipId}/redemptions/{redemptionId} {
      // Read/Write rules: Only the owner can manage their own redemptions.
      allow read, write: if isOwner(membershipId);
    }

    /**
     * @description Rules for the /memberships/{membershipId}/visitSummaries/{visitSummaryId} collection.
     * @path /memberships/{membershipId}/visitSummaries/{visitSummaryId}
     * @allow (create) User A can create a visit summary under their membership (request.auth.uid == 'A').
     * @deny (create) User B cannot create a visit summary under User A's membership (request.auth.uid == 'B', membershipId == 'A').
     * @allow (get) User A can read their own visit summary.
     * @deny (get) User B cannot read User A's visit summary.
     * @principle Enforces document ownership for visit summaries.
     */
    match /memberships/{membershipId}/visitSummaries/{visitSummaryId} {
      // Read/Write rules: Only the owner can manage their own visit summaries.
      allow read, write: if isOwner(membershipId);
    }

    /**
     * @description Rules for the /memberships/{membershipId}/transactions/{transactionId} collection.
     * @path /memberships/{membershipId}/transactions/{transactionId}
     * @allow (create) User A can create a transaction record under their membership (request.auth.uid == 'A').
     * @deny (create) User B cannot create a transaction record under User A's membership (request.auth.uid == 'B', membershipId == 'A').
     * @allow (get) User A can read their own transaction record.
     * @deny (get) User B cannot read User A's transaction record.
     * @principle Enforces document ownership for transactions.
     */
    match /memberships/{membershipId}/transactions/{transactionId} {
      // Read/Write rules: Only the owner can manage their own transactions.
      allow read, write: if isOwner(membershipId);
    }
  }
}
